<html>
    <head>
        <meta charset="UTF-8">
        <title>Redux in 5 minutes</title>
        <meta notes="https://youtu.be/oD3miHerQbY">
        <meta bulma-documentation="https://bulma.io/documentation/layout/level/">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    </head>
    <body>
      
        <!-- Header -->
        <section class="hero is-primary">
            <div class="hero-body">
                <p class="title">
                    Redux and Bulmo.io
                </p>
            </div>
        </section>

        <!-- Content -->
        <section class="section">          

            <div class="container">

                <div class="tile is-ancestor">

                    <!-- Left Column -->
                    <div class="tile is-4 is-vertical is-parent">
                        <div class="tile is-child box">
                            <h1 class="title">Todo Form</h1>
                            <div class="level">
                                <input id="todo-input" type="text" class="input">
                                <button id="submit-todo" class="button is-light">submit</button>
                                <button id="load-data" class="button is-dark">load data</button>                   
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="tile is-parent">
                        <div class="tile is-child box">
                            <div class="title">List</div>
                            <div id="container"></div>
                        </div>
                    </div>
                </div>    
                
                <nav class="level">
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">List Items</p>
                            <p id="list-item-count" class="title"></p>
                        </div>
                    </div>
                </nav>
               
            </div>
        </section>

        <!-- Footer -->
        <div class="footer">This is the footer</div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>

            // The Reducer is a Finite State Machine which processes dispatched messages.
            const reducer = Redux.combineReducers({
                todos: (state = [], action) => {
                    const newState = Object.assign([], state);

                    // Add Message
                    if (action.type =='add') {
                        newState.push(action.item);
                    }

                    // Remove Message
                    if (action.type =='remove') {
                        newState.splice(action.index, 1)
                    }

                    return newState;
                }
            });


            // Create Storage Object
            const store = Redux.createStore(reducer);
            

            // Rendering function
            const render = () => {

                /// RENDER THE ITEM LIST

                // Get Container element and empty it.
                const container = document.getElementById('container');
                container.innerHTML = '';

                const state = store.getState();

                state.todos.forEach((todo, i) => {
                    const el = document.createElement('div');
                    el.innerHTML = todo;
                    container.appendChild(el);
                    el.onclick = () => {
                        // Send message to remove
                        store.dispatch({
                            type: 'remove',
                            index: i
                        });
                        // Redraw the component
                        render();
                    };
                });


                /// RENDER THE ITEM LIST COUNT

                // Get list item element and empty it.
                const countContainer = document.getElementById('list-item-count');
                countContainer.innerHTML = '';
                countContainer.innerHTML = state.todos.length;

            };


            // Wire up the submit button
            document.getElementById('submit-todo').onclick = () => {
                const fieldValue = document.getElementById('todo-input').value;
                console.log(fieldValue);
                addItem(fieldValue);
            };

            document.getElementById('load-data').onclick = () => {
                getUsers();
            }


            // Wire up the input text box to fire on Enter key press
            // https://stackoverflow.com/questions/7060750/detect-the-enter-key-in-a-text-input-field
            document.getElementById('todo-input').addEventListener("keyup", ({key}) => {
                if (key == "Enter") {
                    console.log("Enter key pressed");

                    const fieldValue = document.getElementById('todo-input').value;
                    console.log(fieldValue);
                    addItem(fieldValue);
                }            
            });


            // Adds item to list and clears the input box.
            function addItem(data)
            {
                console.log(data) 

                // Send message to add item
                store.dispatch({
                    type: 'add',
                    item: data
                });

                // Redraw the component
                render();

                // Clear the input 
                document.getElementById('todo-input').value = "";
            }


            // Example of populating list Web API using Axios.
            async function getUsers() 
            {
                await axios.get('https://jsonplaceholder.typicode.com/users').then(resp => 
                {
                    console.log(resp.data);

                    resp.data.forEach((user, i) => {
                        addItem(user.name);                        
                    });               
                });
            }
      

        </script>
    </body>
</html>