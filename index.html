<html>
    <head>
        <meta charset="UTF-8">
        <title>Redux in 5 minutes</title>
        <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
        <meta redux-tutorial="https://youtu.be/oD3miHerQbY">
        <meta bulma-documentation="https://bulma.io/documentation/layout/level/">
        <meta data-source="https://my-json-server.typicode.com/">
        <meta icon-notes="https://ionic.io/ionicons">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    </head>
    <body>
      
        <!-- Header -->
        <section class="hero is-primary">
            <div class="hero-body">
                <p class="title">
                    Redux, Bulmo.io, Unsplash and My Json Server
                    <a class="button is-primary modal-button is-large is-pulled-right" data-target="help-modal">
                        <ion-icon id="help-modal-trigger" name="ice-cream-outline"></ion-icon>
                    </a>
                </p>
            </div>
        </section>

        <!-- Content -->
        <section class="section">          

            <div class="container">

                <div class="tile is-ancestor">

                    <!-- Left Column -->
                    <div class="tile is-4 is-vertical is-parent">
                        <div class="tile is-child box">
                            <h1 class="title">Todo Form</h1>
                            <div class="level">
                                <input id="todo-input" type="text" class="input">
                                <button id="submit-todo" class="button is-light">submit</button>
                                <button id="load-data" class="button is-dark">load data</button>                   
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="tile is-parent">
                        <div class="tile is-child box">
                            <div class="title">List</div>
                            <div id="container"></div>
                        </div>
                    </div>
                </div>    
                
                <nav class="level">
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">List Items</p>
                            <p id="list-item-count" class="title"></p>
                        </div>
                    </div>
                </nav>

                <nav class="level">
                    <div class="level-item has-text-centered">
                        <figure class="image is-128x128 is-clipped">
                            <a href="">
                                <img class="is-rounded1 box" src="blank.png" alt="Unsplash 1"/>
                            </a>
                        </figure>
                    </div>
                    <div class="level-item has-text-centered">
                        <figure class="image is-128x128 is-clipped">
                            <a href="">
                                <img class="is-rounded box" src="blank.png" alt="Unsplash 2"/>
                            </a>
                        </figure>
                    </div>
                    <div class="level-item has-text-centered">
                        <figure class="image is-128x128 is-clipped">
                            <a href="">
                                <img class="is-rounded1 box" src="blank.png" alt="Unsplash 3"/>
                            </a>
                        </figure>
                    </div>     
                    <div class="level-item has-text-centered">
                        <figure class="image is-128x128 is-clipped">
                            <a href="">
                                <img class="is-rounded box" src="blank.png" alt="Unsplash 3"/>
                            </a>
                        </figure>
                    </div>     
                    <div class="level-item has-text-centered">
                        <figure class="image is-128x128 is-clipped">
                            <a href="">
                                <img class="is-rounded1 box" src="blank.png" alt="Unsplash 3"/>
                            </a>
                        </figure>
                    </div>                    
                </nav>
               
            </div>
        </section>

        <!-- Footer -->
        <div class="footer">This is the footer</div>

        <!-- Custom Modals -->
        <div id="help-modal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Modal Title</p>
                    <button class="delete" aria-label="close"></button>
                </header>
                <section class="modal-card-body">
                    <!-- content -->
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-success">Save changes</button>
                    <button class="button">Cancel</button>
                </footer>
            </div>
        </div>
        
        <script src="modal.js"></script>
        <script src="data.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

        <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
        <script>

            // The Reducer is a Finite State Machine which processes dispatched messages.
            const reducer = Redux.combineReducers({
                todos: (state = [], action) => {
                    const newState = Object.assign([], state);

                    // Add Message
                    if (action.type =='add') {
                        newState.push(action.item);
                    }

                    // Remove Message
                    if (action.type =='remove') {
                        newState.splice(action.index, 1)
                    }

                    return newState;
                }
            });


            // Create Storage Object
            const store = Redux.createStore(reducer);
            

            // Rendering function
            const render = () => {

                /// RENDER THE ITEM LIST

                // Get Container element and empty it.
                const container = document.getElementById('container');
                container.innerHTML = '';

                const state = store.getState();

                state.todos.forEach((todo, i) => {
                    const el = document.createElement('div');
                    el.innerHTML = todo;
                    container.appendChild(el);
                    el.onclick = () => {
                        // Send message to remove
                        store.dispatch({
                            type: 'remove',
                            index: i
                        });
                        // Redraw the component
                        render();
                    };
                });


                /// RENDER THE ITEM LIST COUNT

                // Get list item element and empty it.
                const countContainer = document.getElementById('list-item-count');
                countContainer.innerHTML = '';
                countContainer.innerHTML = state.todos.length;

            };

            /// --------------------------------------------------------------------------------------------------------

            // Wire up the submit button
            document.getElementById('submit-todo').onclick = () => {
                const fieldValue = document.getElementById('todo-input').value;
                console.log(fieldValue);
                addItem(fieldValue);
            };

            // Wire up the load data button
            document.getElementById('load-data').onclick = () => {
                //getUsers();
                getTasks();
            }

            // Load the image containers
            loadImages();

          
            /// -----------------------------------------------------------------------------------------------------------


            // Wire up the input text box to fire on Enter key press
            // https://stackoverflow.com/questions/7060750/detect-the-enter-key-in-a-text-input-field
            document.getElementById('todo-input').addEventListener("keyup", ({key}) => {
                if (key == "Enter") {
                    console.log("Enter key pressed");

                    const fieldValue = document.getElementById('todo-input').value;
                    console.log(fieldValue);
                    addItem(fieldValue);
                }            
            });


            // Adds item to list and clears the input box.
            function addItem(data)
            {
                console.log(data) 

                // Send message to add item
                store.dispatch({
                    type: 'add',
                    item: data
                });

                // Redraw the component
                render();

                // Clear the input 
                document.getElementById('todo-input').value = "";
            }


            // Example of populating list Web API using Axios.
            async function getUsers() 
            {
                await axios.get('https://jsonplaceholder.typicode.com/users').then(resp => 
                {
                    console.log(resp.data);

                    resp.data.forEach((user, i) => {
                        addItem(user.name);                        
                    });               
                });
            }


            /// Tasks

            // Example of populating list using custom fake rest server
            async function getTasks()
            {
                // Retrieve list of Tasks from arbitrary data source.  When available, send tasks to Render Function.
                const results = await fetchTasks().then(resp =>
                {
                    renderTasks(resp.data);
                });
            }  
            
            function renderTasks(model)
            {
                model.forEach((task,i) => 
                {
                    addItem(task.text);
                });
            }


            /// Images

            async function loadImages()
            {

                // Display loading spinners                
                var $figures = document.querySelectorAll('figure');   
                $figures.forEach((figure, i) => 
                {
                    figure.classList.add("loader");
                    figure.classList.add("is-loading");
                })

                // Make a call out to service to retrieve images
                const results = await fetchImages().then(resp =>
                {  
                    var images = [];
                    
                    // Shrink the dataset down and grab only the fields we want.
                    var subset = resp.data.results.slice(0, 10).forEach((item) => {
                        const image = { "link" : item.urls.small, 
                                        "home" : item.links.html, 
                                        "description" : item.description ?? item.alt_description, 
                                        "user" : item.user.name }
                        images.push(image);
                    });                    

                    console.log(images);

                    // Update the image containers on the page.
                    renderImages(images);                    
                }); 
            }

            function renderImages(model)
            {
                // Get images 
                var $imageRow = document.querySelectorAll('figure img');                
                var $linkRow = document.querySelectorAll('figure a');                

                $imageRow.forEach((image, i) =>
                {
                    // Simulate a delay in retrieving images.
                    window.setTimeout(function() 
                    {
                        console.log("sleep" + i);                   

                        image.src = model[i].link;
                        image.title = model[i].user + ": " + model[i].description;
                        image.parentElement.href = model[i].home;

                        // Remove the loading spinner
                        image.parentElement.parentElement.classList.remove("loader");
                        image.parentElement.parentElement.classList.remove("is-loading");
                    }, (Math.random() * 500) * (i+1));

                })
            }

        </script>
    </body>
</html>